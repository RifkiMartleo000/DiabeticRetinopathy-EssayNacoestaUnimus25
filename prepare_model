import tensorflow as tf
import json
import os
import numpy as np

# Create model directory if it doesn't exist
os.makedirs("model", exist_ok=True)

# Load model architecture from JSON
try:
    with open("64x3-CNN.json", "r") as json_file:
        model_json = json_file.read()
    
    print("Model JSON loaded successfully.")
    
    # Create model from JSON
    model = tf.keras.models.model_from_json(model_json)
    
    print("Model created from JSON successfully.")
    
    # Compile the model with the same configuration
    model.compile(
        optimizer=tf.keras.optimizers.Adam(learning_rate=1e-5),
        loss='binary_crossentropy',
        metrics=['acc']
    )
    
    # Initialize weights with random values if no trained weights are available
    # This is just for demonstration - in production you'd load real trained weights
    print("Initializing random weights (for demonstration purposes)...")
    
    # Generate a random image for model initialization and summary
    dummy_input = np.random.random((1, 224, 224, 3)).astype(np.float32)
    model.predict(dummy_input)
    
    # Print model summary
    model.summary()
    
    # Save model architecture to model directory
    with open(os.path.join("model", "64x3-CNN.json"), "w") as json_file:
        json_file.write(model.to_json())
    
    # Save model weights
    model.save_weights(os.path.join("model", "64x3-CNN_weights.h5"))
    
    # Save complete model in SavedModel format
    model.save(os.path.join("model", "saved_model"))
    
    # Convert to TensorFlow Lite format for more efficient deployment
    converter = tf.lite.TFLiteConverter.from_keras_model(model)
    tflite_model = converter.convert()
    
    with open(os.path.join("model", "model.tflite"), "wb") as f:
        f.write(tflite_model)
    
    print("\nModel files successfully created in 'model/' directory:")
    print("- 64x3-CNN.json (architecture)")
    print("- 64x3-CNN_weights.h5 (weights)")
    print("- saved_model/ (complete SavedModel)")
    print("- model.tflite (TFLite format)")
    print("\nYou can now deploy the app with the created model files.")
    
except Exception as e:
    print(f"Error processing model: {str(e)}")
    print("\nPlease ensure your model JSON file '64x3-CNN.json' is in the current directory.")
